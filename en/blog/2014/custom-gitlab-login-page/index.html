<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8">
        <title>Custom GitLab login page</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta http-equiv="Pragma" content="no-cache" />
        <meta http-equiv="Expires" content="-1" />
        <link rel="stylesheet" href="/theme/style/reset.css" type="text/css" />
        <link rel="stylesheet" href="/theme/style/screen.css" type="text/css" />
        <link rel="stylesheet" href="/theme/style/friendly.css" type="text/css" />
        <link rel="stylesheet" href="/theme/style/print.css" type="text/css" media="print" />
        <link href="http://axilleas.me/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="Over the line RSS Feed" />
</head>
<body>
    <header id="main">
        <div class="container">
            <div class="logo">
                <p><a href="/" title="Home">Over the line</a> <span class="welcome">Yeah, well, you know, that's just, like, my opinion, man.</span></p>
            </div>
        </div>
    </header>

    <div class="splash">
        <div class="container">
            <ul>
                <li><a href="/">Home</a></li>
                    <li><a href="/about">whoami</a></li>
                    <li><a href="/rss">Rss Feed</a></li>
                <li><a href="/archives.html" title="Archive">Archive</a></li>
            </ul>
        </div>
    </div>

    <div class="container content">
<article>
    <header>
<h1><a href="/en/blog/2014/custom-gitlab-login-page" rel="bookmark">
    Custom GitLab login page
</a></h1>
<time datetime="2014-07-28 00:00:00" pubdate>Posted on
    Mon 28 July 2014
</time>
<address class="vcard author">
    by <a class="url fn" href="/author/axil.html">
    axil</a>
</address>
<span class="category">in <a href="/category/geek.html">
    geek</a>.
        </span>
    </header>

    <div class="body">
        <p>With the <a href="https://about.gitlab.com/2014/07/22/gitlab-7-dot-1-released/" title="Blog post: GitLab 7.1 released">release of GitLab 7.1</a>, the login page now looks like the
default Enterprise Edition. Although in EE customizing the page should be
easier to configure, we can do the same with Community Edition following
some simple steps. If you are familiar with <a href="http://haml.info/docs/yardoc/file.REFERENCE.html" title="haml yardoc files">haml</a> and <a href="http://getbootstrap.com" title="Bootstrap framework">bootstrap</a>
this should be fairly easy for you. Again, prerequisite is to have at least
GitLab 7.1. You can see the final changes in this <a href="https://github.com/axilleas/gitlabhq/commit/953a8bc25f1cb5366026e6489c2716d0db69265c">commit</a>.</p>
<p>Here is a before/after screenshot that we will gradually change.</p>
<p><img alt="Before" src="http://axilleas.me/images/gitlab_custom_login_before.png" /></p>
<p><img alt="After" src="http://axilleas.me/images/gitlab_custom_login_after.png" /></p>
<div class="toc">
<ul>
<li><a href="#introductory-steps">Introductory steps</a><ul>
<li><a href="#haml-identation">haml identation</a></li>
<li><a href="#git-branch">git branch</a></li>
</ul>
</li>
<li><a href="#change-brand-logo">Change brand logo</a></li>
<li><a href="#change-text">Change text</a><ul>
<li><a href="#brand-title">Brand title</a></li>
<li><a href="#body-description">Body description</a></li>
</ul>
</li>
<li><a href="#change-footer-links">Change footer links</a></li>
<li><a href="#change-font">Change font</a></li>
<li><a href="#commit-changes">Commit changes</a></li>
<li><a href="#updating-gitlab">Updating GitLab</a></li>
<li><a href="#reverting-changes">Reverting changes</a></li>
<li><a href="#what-about-omnibus">What about omnibus?</a></li>
</ul>
</div>
<h2 id="introductory-steps">Introductory steps</h2>
<h3 id="haml-identation">haml identation</h3>
<p>It is important to use an editor that has set a tab to two spaces.
Haml depends on indentation so any mistake will yield errors. If you see
any 500 errors, it means something went wrong. Either check the unicorn logs
or better, run <code>git diff</code> to see if there are any indentation errors.</p>
<p>If you are using vim, create/open <code>/home/git/.vimrc</code> and place the following
lines:</p>
<div class="codehilite"><pre><span class="n">set</span> <span class="n">tabstop</span><span class="o">=</span><span class="mi">2</span>
<span class="n">set</span> <span class="n">shiftwidth</span><span class="o">=</span><span class="mi">2</span>
<span class="n">set</span> <span class="n">expandtab</span>
</pre></div>


<p>That will ensure proper indentation handling.</p>
<h3 id="git-branch">git branch</h3>
<p>In order to have more seamless future updates, let's create a separate git
branch:</p>
<div class="codehilite"><pre>su - git
<span class="nb">cd</span> /home/git/gitlab/
git checkout -b custom_login_page
</pre></div>


<p>All changes we make from now on, will be on that branch without creating
any mess in future updates. Read below on how to update.</p>
<hr />
<p>The main file we need to change is <code>app/views/layouts/devise.html.haml</code>,
relative to where GitLab is installed.</p>
<h2 id="change-brand-logo">Change brand logo</h2>
<p>Choose the image you want to appear in the login page and place it in
<code>/home/git/gitlab/app/assets/images/</code>.</p>
<p>Next, open <code>app/views/layouts/devise.html.haml</code> with an editor and change
<a href="https://gitlab.com/gitlab-org/gitlab-ce/blob/master/app/views/layouts/devise.html.haml#L22">line 22</a> replacing <code>brand_logo.png</code> with your image name including
its extension.</p>
<p>Since we alter the production server, remember to recompile the assets so
that the <a href="http://guides.rubyonrails.org/asset_pipeline.html" title="Rails asset pipeline">Rails asset pipeline</a> picks the new image (do that every
time you put a new file or change something in <code>app/assets/</code>):</p>
<div class="codehilite"><pre><span class="nb">cd</span> /home/git/gitlab/
sudo -u git <span class="nv">RAILS_ENV</span><span class="o">=</span>production bundle <span class="nb">exec </span>rake assets:precompile
</pre></div>


<p>Finally, restart the GitLab service to see the changes.</p>
<h2 id="change-text">Change text</h2>
<p>Apart from the logo, there is a lot more we can change. Let's try changing
the text.</p>
<h3 id="brand-title">Brand title</h3>
<p>In order to change the text reading <em>GitLab Community Edition</em>, open
<code>devise.html.haml</code> and change <code>%h1= brand_title</code> in line 9 into
<code>%h1 My custom brand title</code>. Here, we removed the equal sign because it
is used by haml to evaluate and print ruby code (<code>brand_title</code> is a helper
method).</p>
<p>If you want an image instead, you can replace <code>%h1= brand_title</code> with
<code>= image_tag 'my_banner.png'</code>.</p>
<h3 id="body-description">Body description</h3>
<p>As you'd imagine, changing the body headline would require to replace
<code>%h2 Open source software to collaborate on code</code> with our own text, or
even remove it completely.</p>
<p>The main body can be changed by altering the text that lies below <code>%p.lead</code>.
Remember to indent correctly.</p>
<p>The text can also contain links. Place each link in its own line.</p>
<p>An example would be:</p>
<div class="codehilite"><pre><span class="n">Accounts</span> <span class="n">are</span> <span class="n">temporarily</span> <span class="n">created</span> <span class="n">manually</span><span class="p">,</span> <span class="n">you</span> <span class="n">can</span> <span class="n">ask</span> <span class="n">one</span> <span class="n">in</span> <span class="n">our</span>
<span class="o">=</span> <span class="n">link_to</span> <span class="s">&quot;forum discussion&quot;</span><span class="p">,</span> <span class="s">&quot;https://forum.example.com/gitlab-reg&quot;</span>
<span class="n">You</span> <span class="n">can</span> <span class="n">find</span> <span class="n">more</span> <span class="n">info</span> <span class="n">in</span> <span class="n">the</span>
<span class="o">=</span> <span class="n">link_to</span> <span class="s">&quot;Wiki.&quot;</span><span class="p">,</span> <span class="s">&quot;https://example.com/wiki/index.php/GitLab&quot;</span>
</pre></div>


<p>A link can also have a <code>target = "_blank"</code> to open in a new window.
The <a href="http://api.rubyonrails.org/classes/ActionView/Helpers/UrlHelper.html#method-i-link_to" title="link_to definition">format</a> is:</p>
<div class="codehilite"><pre><span class="o">=</span> <span class="n">link_to</span> <span class="s">&quot;text&quot;</span><span class="p">,</span> <span class="s">&quot;http://example.com&quot;</span><span class="p">,</span> <span class="n">target</span><span class="o">:</span> <span class="s">&quot;blank&quot;</span>
</pre></div>


<h2 id="change-footer-links">Change footer links</h2>
<p>Footer links are in <a href="https://gitlab.com/gitlab-org/gitlab-ce/blob/master/app/views/layouts/devise.html.haml#L35">line 35</a>. Just change their content or add new
ones like we talked above.</p>
<h2 id="change-font">Change font</h2>
<p>The text I used was in Greek, so it looked aweful since the default font
is <em>Helvetica Neue</em>. I decided to change it and use a webfont that supports
my language. I went with <em>Open Sans</em> from <a href="https://www.google.com/fonts">https://www.google.com/fonts</a>.</p>
<p>Now, there are 3 changes we need to do:</p>
<ol>
<li>Create our custom css file which imports the font and sets the classes</li>
<li>Change <code>devise.html.haml</code> and include the new css classes.</li>
<li>Include our custom css in <code>application.scss</code>.</li>
</ol>
<p>For the first step I created <code>app/assets/stylesheets/custom_login.scss</code>
with contents:</p>
<div class="codehilite"><pre><span class="err">@</span><span class="n">import</span> <span class="n">url</span><span class="p">(</span><span class="n">http</span><span class="o">:</span><span class="c1">//fonts.googleapis.com/css?family=Open+Sans&amp;subset=latin,greek);</span>

<span class="p">.</span><span class="n">custom</span><span class="o">-</span><span class="n">login</span> <span class="p">{</span>
  <span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="p">,</span> <span class="n">p</span> <span class="p">{</span>
  <span class="n">font</span><span class="o">-</span><span class="n">family</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">Open</span> <span class="n">Sans</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">sans</span><span class="o">-</span><span class="n">serif</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Here I used <a href="http://sass-lang.com/guide">sass</a>. These are nested values that will be picked by html.</p>
<p>The second step is to change <code>devise.html.haml</code> and include the new
<code>custom-login</code> css class. There were 2 places where I needed to do that:</p>
<div class="codehilite"><pre><span class="o">-</span> <span class="p">.</span><span class="n">brand_text</span><span class="p">.</span><span class="n">hidden</span><span class="o">-</span><span class="n">xs</span>
<span class="o">+</span> <span class="p">.</span><span class="n">brand_text</span><span class="p">.</span><span class="n">hidden</span><span class="o">-</span><span class="n">xs</span><span class="p">.</span><span class="n">custom</span><span class="o">-</span><span class="n">login</span>

<span class="o">-</span> <span class="o">%</span><span class="n">p</span><span class="p">.</span><span class="n">lead</span>
<span class="o">+</span> <span class="o">%</span><span class="n">p</span><span class="p">.</span><span class="n">lead</span><span class="p">.</span><span class="n">custom</span><span class="o">-</span><span class="n">login</span>
</pre></div>


<p>Third step is to include the custom css in <code>application.scss</code>. I opened
<code>app/assets/stylesheets/application.scss</code> and appended at the very end of
the file the following:</p>
<div class="codehilite"><pre><span class="cm">/**</span>
<span class="cm">* Styles for custom login page</span>
<span class="cm">*/</span>
<span class="cp">@import</span> <span class="s2">&quot;custom_login.scss&quot;</span><span class="p">;</span>
</pre></div>


<p>Finally, in order for the new css to get included in the asset pipeline I
precompiled the assets one more time:</p>
<div class="codehilite"><pre><span class="nb">cd</span> /home/git/gitlab/
sudo -u git <span class="nv">RAILS_ENV</span><span class="o">=</span>production bundle <span class="nb">exec </span>rake assets:precompile
</pre></div>


<p>And while I was trying to precompile the assets after adding my custom css,
it failed to do so because of a missing semicolon in <code>application.scss</code>.
I immediately opened a <a href="https://gitlab.com/gitlab-org/gitlab-ce/merge_requests/157">Merge Request</a>, so either wait for it to get
merged or add it yourself for now. You got to love open source :)</p>
<p>Screenshots of before/after font change. You can see that before the changes
Greek and English words are using different fonts.</p>
<p><img alt="Before font change" src="http://axilleas.me/images/gitlab_custom_login_prefont.png" /></p>
<p><img alt="After font change" src="http://axilleas.me/images/gitlab_custom_login_afterfont.png" /></p>
<h2 id="commit-changes">Commit changes</h2>
<p>The login page should now work correctly providing all the needed info for
our users. It's time to commit our changes. Check the diff with <code>git diff</code>
one more time, and make sure you are on the right branch with <code>git branch</code>.
It should show <code>* custom_login_page</code>. Add and commit the changed files:</p>
<div class="codehilite"><pre><span class="n">git</span> <span class="n">add</span> <span class="n">app</span><span class="o">/</span>
<span class="n">git</span> <span class="n">commit</span> <span class="o">-</span><span class="n">m</span> <span class="err">&#39;</span><span class="n">Custom</span> <span class="n">login</span> <span class="n">page</span><span class="p">.</span><span class="err">&#39;</span>
</pre></div>


<h2 id="updating-gitlab">Updating GitLab</h2>
<p>The trickiest part is to maintain the code through the updates and avoid as
many confilcts as possible.</p>
<p>Before each update, these are the basic steps:</p>
<ol>
<li>Stop gitlab service</li>
<li>Run <code>git fetch --all</code></li>
<li>Run <code>git branch 7-1-stable origin/7-1-stable</code> (replace with appropriate version)</li>
<li>Run <code>git rebase 7-1-stable custom_login</code></li>
<li>Follow the rest of instructions (db:migrate, assets:precompile, etc.)</li>
</ol>
<p>The trick here is rebase. This git command will replay our changes over the
new branch we fetched from upstream. If there are no conflicts, the custom
login changes will remain. Otherwise, git will inform you and then you'd
have to first resolve any issues before rebasing.</p>
<h2 id="reverting-changes">Reverting changes</h2>
<p>In order to revert to the original login page, it's as simple as changing
branches and restarting the GitLab service.</p>
<h2 id="what-about-omnibus">What about omnibus?</h2>
<p>If you have installed GitLab through the omnibus packages, the GitLab root
path will be <code>/opt/gitlab/embedded/service/gitlab-rails/</code> so make any
changes relative to that path. I haven't tested it yet though, so I don't
know whether any changes get rewritten with package updates (probably that
is the case).</p>
<p>On the other hand, if you work at a company that uses omnibus, consider
going for the Enterprise Edition where this process would be more easier
and at the same time you support the future development of GitLab :)</p>
    </div>

    <footer>
        <ul class="tags">
        Tags:
            <li><a href="/tag/ruby.html">ruby</a></li>
            <li><a href="/tag/rails.html">rails</a></li>
            <li><a href="/tag/webdev.html">webdev</a></li>
            <li><a href="/tag/gitlab.html">gitlab</a></li>
            <li><a href="/tag/haml.html">haml</a></li>
        </ul>
    </footer>

    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'kissmyarch'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</article>
    </div>

    <div class="container footnote">
        <a href="javascript:window.print();" title="Print">Print</a>
    </div>



    <footer>
        <div class="container footer">
            <span>Powered by <a href="http://docs.getpelican.com">
                Pelican</a> using <a href="https://github.com/BYK/pelican-neat">
                neat theme</a>. 
            </span>
            <nav>
                <ul>
                    <li><a href="https://github.com/axilleas/axilleas.github.io/tree/source" title="Source code">Source code</a></li>
                <li><a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/3.0/"><img
                    alt="Creative Commons License" src="http://i.creativecommons.org/l/by-nc-nd/3.0/80x15.png"></a></li>
                </ul>
            </nav>
        </div>
    </footer>
     <!-- Piwik -->
    <script type="text/javascript">
      var _paq = _paq || [];
      _paq.push(["trackPageView"]);
      _paq.push(["enableLinkTracking"]);

      (function() {
        var u=(("https:" == document.location.protocol) ? "https" : "http") + "://piwik-glb.rhcloud.com/";
        _paq.push(["setTrackerUrl", u+"piwik.php"]);
        _paq.push(["setSiteId", "5"]);
        var d=document, g=d.createElement("script"), s=d.getElementsByTagName("script")[0]; g.type="text/javascript";
        g.defer=true; g.async=true; g.src=u+"piwik.js"; s.parentNode.insertBefore(g,s);
      })();
    </script>
    <!-- End Piwik Code -->
</body>
</html>